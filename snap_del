pipeline {
    agent any
    environment {
        AWS_REGION = 'eu-north-1'              // Replace with your AWS region
        DAYS_OLD = 0                           // Number of days to consider a snapshot "old"
        AWS_CREDENTIALS_ID = 'aws-credentials' // Replace with the credentials ID for AWS in Jenkins
    }
    stages {
        stage('Clone Repository') {
            steps {
                // Fetch code from GitHub
                checkout scm
            }
        }
        stage('List Old Snapshots') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding', 
                    credentialsId: aws-credentials
                ]]) {
                    script {
                        echo "Listing EC2 snapshots older than ${DAYS_OLD} day(s)..."
                        
                        // Get date in the format required by AWS EC2 API
                        def dateFormat = new Date() - DAYS_OLD
                        def formattedDate = dateFormat.format("yyyy-MM-dd'T'HH:mm:ss'Z'")
                        
                        sh """
                            aws ec2 describe-snapshots --region $AWS_REGION \
                                --query "Snapshots[?StartTime<'${formattedDate}'].[SnapshotId, StartTime]" \
                                --output table
                        """
                    }
                }
            }
        }
        stage('Delete Old Snapshots') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding', 
                    credentialsId: AWS-credentials
                ]]) {
                    script {
                        echo "Deleting EC2 snapshots older than ${DAYS_OLD} day(s)..."
                        
                        // Get date in the format required by AWS EC2 API
                        def dateFormat = new Date() - DAYS_OLD
                        def formattedDate = dateFormat.format("yyyy-MM-dd'T'HH:mm:ss'Z'")
                        
                        // Get snapshot IDs
                        def snapshotIds = sh(script: """
                            aws ec2 describe-snapshots --region $AWS_REGION \
                                --query "Snapshots[?StartTime<'${formattedDate}'].[SnapshotId]" \
                                --output text
                        """, returnStdout: true).trim().split("\n")
                        
                        // Delete each snapshot
                        snapshotIds.each { snapshotId ->
                            echo "Deleting snapshot ${snapshotId}"
                            sh """
                                aws ec2 delete-snapshot --region $AWS_REGION --snapshot-id ${snapshotId}
                            """
                        }
                    }
                }
            }
        }
    }
    post {
        success {
            echo "Pipeline completed successfully. Old snapshots deleted."
        }
        failure {
            echo "Pipeline failed. Check the logs for details."
        }
    }
}
