pipeline {
    agent any
    environment {
        AWS_REGION = 'eu-north-1'                 // Your AWS region
        DAYS_OLD = 0                             // Number of days to consider a snapshot "old"
        AWS_CREDENTIALS_ID = 'AWS-credentials'   // Your AWS credentials ID in Jenkins
    }
    stages {
        stage('Clone Repository') {
            steps {
                // Fetch code from GitHub
                checkout scm
            }
        }
        stage('List Old Snapshots') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: AWS_CREDENTIALS_ID
                ]]) {
                    script {
                        echo "Listing EC2 snapshots older than ${DAYS_OLD} day(s)..."
                        def accountId = bat(script: "aws sts get-caller-identity --query 'Account' --output text", returnStdout: true).trim()
                        echo "AWS Account ID: ${accountId}"
                        
                        bat """
                            aws ec2 describe-snapshots --region $AWS_REGION --owner-ids $accountId \
                                --query 'Snapshots[?StartTime<date -d "$DAYS_OLD day ago" +"%Y-%m-%dT%H:%M:%SZ"].[SnapshotId, StartTime]' \
                                --output table
                        """
                    }
                }
            }
        }
        stage('Delete Old Snapshots') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: AWS_CREDENTIALS_ID
                ]]) {
                    script {
                        echo "Deleting EC2 snapshots older than ${DAYS_OLD} day(s)..."
                        def accountId = sh(script: "aws sts get-caller-identity --query 'Account' --output text", returnStdout: true).trim()
                        echo "AWS Account ID: ${accountId}"

                        def snapshotIds = sh(script: """
                            aws ec2 describe-snapshots --region $AWS_REGION --owner-ids $accountId \
                                --query 'Snapshots[?StartTime<date -d "$DAYS_OLD day ago" +"%Y-%m-%dT%H:%M:%SZ"].SnapshotId' \
                                --output text
                        """, returnStdout: true).trim().split("\n")
                        
                        snapshotIds.each { snapshotId ->
                            echo "Deleting snapshot ${snapshotId}"
                            bat """
                                aws ec2 delete-snapshot --region $AWS_REGION --snapshot-id ${snapshotId}
                            """
                        }
                    }
                }
            }
        }
    }
    post {
        success {
            echo "Pipeline completed successfully. Old snapshots deleted."
        }
        failure {
            echo "Pipeline failed. Check the logs for details."
        }
    }
}
